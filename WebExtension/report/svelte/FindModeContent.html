<script>
import l10n from "../../l10nStore.module.js";
import { findModeContentHelper as helper } from "../core.module.js";
import DeviantList from "./DeviantList.html";
import DeviationList from "./DeviationList.html";
import Avatar from "./Avatar.html";
import { afterUpdate, createEventDispatcher } from 'svelte';

const dispatch = createEventDispatcher();

let input = "", submitted;
let queryResults, oldQueryResults;
export let watchedArtists;
let openDeviant;

let deviantList;

// TODO: Make this component reactive to subaccounts changes
$: queryError = helper.validateQuery(input);
function handleSubmit() {
	if (queryError || input == "") { return; }
	submitted = input;
	queryResults = helper.submitQuery(submitted);
	// If results consist of nothing but 1 deviant, open their DeviantEntry
	if (queryResults.deviants.length == 1 && !queryResults.deviations.length) {
		openDeviant = queryResults.deviants[0].name;
	} else {
		openDeviant = "";
	}
}
afterUpdate(() => {
	if (queryResults != oldQueryResults) {
		// Set subaccount notes
		if (oldQueryResults && oldQueryResults.matchedBySubaccount && deviantList) {
			for (let deviant of Object.keys(oldQueryResults.matchedBySubaccount)) {
				let entry = deviantList.registry[deviant];
				if (!entry) { continue; }
				entry.$set({note: null});
			}
		}
		if (queryResults.matchedBySubaccount) {
			for (let [deviant, subaccount] of Object.entries(queryResults.matchedBySubaccount)) {
				deviantList.registry[deviant].$set(
					{ note: ["foundDeviantSubaccount", {name: subaccount}] } );
			}
		}

		oldQueryResults = queryResults;
	}
});

let showAmpersandHint;
$: {
	let checkMe = submitted || input;
	showAmpersandHint = checkMe.indexOf(" ") != -1 && checkMe.indexOf("&") == -1;
}

$: hasResults = queryResults &&
	Boolean(queryResults.deviants.length || queryResults.deviations.length);
</script>

<form id="findBar" class="textEntryLine" on:submit|preventDefault="{handleSubmit}">
	<input type="text" id="query" bind:value="{input}" autofocus>
	<button type="submit" id="goFind">{$l10n("findGo")}</button>
	<button type="button" class="closeButton" on:click="{() => dispatch('close')}">
		{$l10n("close")}</button>
</form>
{#if queryError}
	<div id="queryError">{$l10n(queryError.errMsg, queryError.parts)}</div>
{/if}
<div id="resultsDisplay" style="overflow-y: auto; overflow-x: hidden; position: relative;"
	class:hasResults>
	{#if queryResults}
		{#if queryResults.deviants.length}
			<div class="sectionHeader">{$l10n("foundDeviants", {num: queryResults.deviants.length})}</div>
			<DeviantList deviants={queryResults.deviants} {watchedArtists} bind:opened={openDeviant}
				bind:this={deviantList}/>
		{/if}
		{#if queryResults.deviations.length}
			<div class="sectionHeader">
				{$l10n("foundDeviations",
					{deviations: queryResults.deviationTotal, artists: queryResults.deviations.length})}
			</div>
			{#each queryResults.deviations as {deviant, deviations} (deviant.name)}
				<div class="deviationResultGroup">
					<div class="deviationResultGroupHeader">
						{$l10n("foundDeviationsArtistHeader", {name: deviant.name})}
					</div>
					<DeviationList {deviations}/>
					<div class="deviationResultGroupSidebar">
						<Avatar {deviant}/>
						<button type="button" class="viewDeviant" on:click="{() => helper.viewDeviant(deviant.name)}">
							{deviant.deviations.length}
						</button>
					</div>
				</div>
			{/each}
		{/if}
		{#if !hasResults}
			<div id="noResults">{$l10n("foundNothing")}</div>
		{/if}
	{:else}
		<div id="findHelp">{$l10n("findHelp")}</div>
	{/if}
	{#if showAmpersandHint}
		<div id="ampersandHint" class="notice">{$l10n("findAmpersandHint")}</div>
	{/if}
</div>