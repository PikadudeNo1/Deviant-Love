<div class="deviant" class:opened="open" id="deviant_{deviant.name}" ref:root>
	<div class="deviantHeader" on:click="fire('openMe')">
		{#if note}
			<div class="deviantNote">{$l10n(...note)}</div>
		{/if}
		{#if watchedArtists}
			{#if watchedArtists.has(deviant.name)}
				<div class="artWatch true" title="{$l10n('artWatched')}">&nbsp;</div>
			{:else}
				<div class="artWatch" title="{$l10n('artNotWatched')}">&nbsp;</div>
			{/if}
		{/if}
		<span class="deviantFaves">{deviant.deviations.length}</span>
		<span class="deviantName">{deviant.name}</span>
		<div class="subaccountsButton line" class:has="deviant.name in $subaccounts"
			class:editing="subaccountsOpen"
			on:click="toggleSubaccounts(event)" title="{$l10n('subaccountsOpen')}">&nbsp;</div>
	</div>
	{#if open || closing}
		<div ref:closerLook class="closerLook touch" style="overflow: hidden; height: auto;">
			<div class="deviantDetails">
				<Avatar {deviant}/>
				<div class="deviantLinks touch">
					<a class="profileLink" href="{deviant.baseURL}">{$l10n("profile")}</a>
					<a class="galleryLink" href="{deviant.baseURL}gallery/">{$l10n("gallery")}</a>
					<a class="favouritesLink" href="{deviant.baseURL}favorites/">{$l10n("favourites")}</a>
					<button type="button" class="subaccountsButton" on:click="toggleSubaccounts()">
						{$l10n("subaccountsOpen")}</button>
				</div>
			</div>
			<DeviationList deviations={deviant.deviations}/>
			{#if subaccountsOpen}
				<MiniSubaccountsEditor owner={deviant.name} />
			{/if}
		</div>
	{/if}
</div>
<script>
import Avatar from "./Avatar.html";
import DeviationList from "./DeviationList.html";
import MiniSubaccountsEditor from "./MiniSubaccountsEditor.html";
import anime from "animejs";
const closerLookEasing = [0, 0, .6, 1];
export default {
	components: { Avatar, DeviationList, MiniSubaccountsEditor },
	onstate({previous}) {
		if (previous) { return; }
		this.get().registry.set(this.get().deviant.name, this);
	},
	ondestroy() {
		this.get().registry.delete(this.get().deviant.name);
	},
	methods: {
		open(transition) {
			this.set({open: true});
			if (transition) {
				var {closerLook} = this.refs;
				var targetHeight = getComputedStyle(closerLook).height;
				anime({
					targets: closerLook,
					height: [0, targetHeight],
					duration: 400,
					easing: closerLookEasing,
					run: () => {
						var openedDeviantElem = this.refs.root;
						var containerElem = openedDeviantElem.offsetParent;
						var scroll = containerElem.scrollTop;
						if (scroll + containerElem.clientHeight <
							openedDeviantElem.offsetTop + openedDeviantElem.offsetHeight) {
							scroll = openedDeviantElem.offsetTop + openedDeviantElem.offsetHeight
								- containerElem.clientHeight;
						}
						if (scroll > openedDeviantElem.offsetTop) {
							scroll = openedDeviantElem.offsetTop;
						}
						containerElem.scrollTop = scroll;
					},
					complete() {
						closerLook.style.height = "auto";
					}
				});
			} else {
				this.refs.root.scrollIntoView();
			}
		},
		close(transition) {
			this.set({open: false, closing: transition, subaccountsOpen: false});
			if (transition) {
				anime({
					targets: this.refs.closerLook,
					height: 0,
					duration: 400,
					easing: closerLookEasing,
					complete: () => {
						this.set({closing: false});
					},
				});
			}
		},
		toggleSubaccounts(event) {
			if (event) { event.stopPropagation(); }
			if (!this.get().subaccountsOpen) {
				this.set({subaccountsOpen: true});
				this.fire("openMe");
			} else {
				this.set({subaccountsOpen: false});
			}
		}
	},
};
</script>