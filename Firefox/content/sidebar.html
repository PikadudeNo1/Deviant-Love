<!--
	This file is part of Deviant Love.
	Copyright 2010 Pikadude No. 1
	Check core.js for the complete legal stuff.
-->
<!doctype html>
<html>
<title>Deviant Love Sidebar</title>
<link rel="stylesheet" href="core/builtinskin.css" type="text/css">
<style type="text/css">
body > div { /* width and height TBD in JavaScript */}
/* body { overflow: hidden; } */
.placeholder { color: rgb(169, 169, 169); }
#lovedArtists { height: 1px; /* Firefox 3.6 will not shrink lovedArtists by itself */ }
a { text-decoration: underline; }
/* These colors were chosen to match what the user sees in the Chrome version on Windows */
a:link { color: rgb(0, 0, 238); }
a:visited { color: rgb(85, 26, 139); }
</style>
<script type="text/javascript" src="core/jquery.js"></script>
<script type="text/javascript" src="core/core.js"></script>
<script type="text/javascript">
var currentXHR, displayType = "sidebar";
$(document).ready( function() {
	window.DeviantLove = true;
	$("body").css("margin", 0);
	setL10n(top.DeviantLove.popupText);
	var reloadButton = top.document.getElementById("DeviantLoveReload");
	reloadButton.addEventListener("command", restart, false);
	reloadButton.hidden = false;
	$(window).bind("unload", function() {
		reloadButton.hidden = true;
		reloadButton.removeEventListener("command", restart, false);
	});
	rawk();
} );
function restart() {
	if (currentXHR) {currentXHR.abort();};
	$("body").empty();
	rawk();
}
function rawk() {
	var pageData = top.DeviantLove.currentPageData;
	if (!pageData) {
		// The sidebar was left open when the user closed the browser. Close it now.
		// Tried handling this in the overlay script, but toggleSidebar wasn't doing anything in load or unload handlers.
		top.toggleSidebar();
	}
	fulfillPurpose(pageData.pageType, pageData.ownerOrTitle);
	var currentURL = pageData.feedHref;
	var scanSettings = {
		dataType: "xml",
		beforeSend: function(XHR) {currentXHR = XHR},
		success: scanFeed,
		error: scanError
	};
	window.scanRetry = function() {
		$.ajax( $.extend( {}, scanSettings, {url: currentURL} ) );
	}
	$.ajax( $.extend( {}, scanSettings, {url: currentURL} ) );
	function scanFeed(feed) {
		var data = [];
		$("item", feed).each( function() {
			var item = {
				deviationName: $("title:eq(0)", this).text(),
				deviationPage: $("link", this).text(),
				artistName: $('[role="author"]:eq(0)', this).text(),
				artistAvatar: $('[role="author"]:eq(1)', this).text(),
				artistProfile: $("copyright", this).attr("url")
			};
			item.artistProfile = "http://" + item.artistName.toLowerCase() + ".deviantart.com"; // Setting this the way I did in Chrome wasn't working.
			item.artistGallery = item.artistProfile + "/gallery/";
			data.push(item);
		} );
		collectData(data);
		var nextPage = $('channel > [rel="next"]', feed);
		if (nextPage.length >= 1) {
			currentURL = nextPage.attr("href");
			$.ajax( $.extend( {}, scanSettings, {url: currentURL} ) );
		} else {
			scanDone_startFun(top.DeviantLove.getTip());
		}
	}
}
$(document).delegate("a", "click", function(event) {
	event.preventDefault();
} ).delegate("a", "mouseup", function(event) {
	// Mimic Chrome behavior
	var where = top.whereToOpenLink(event);
	if (where == "current") {
		top.gBrowser.selectedTab = top.gBrowser.addTab(this.href);
	} else {
		top.openUILinkIn(this.href, where);
	}
} );
$(window).bind("resize", function() {
	var screenSize = document.styleSheets[1].cssRules[0].style;
	screenSize.setProperty("width", $(window).width() + "px", "");
	screenSize.setProperty("height", $(window).height() + "px", "");
} );
</script>
<body class="sidebar"></body>
</html>