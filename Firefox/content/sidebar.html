<!--
	This file is part of Deviant Love.
	Copyright Pikadude No. 1
	Check core.js for the complete legal stuff.
-->
<!doctype html>
<html>
<title>Deviant Love Sidebar</title>
<base href="chrome://DeviantLoveWebExt/content/">
<link rel="stylesheet" href="core/builtinskin.css" type="text/css">
<style type="text/css">
body { height: 100vh; }
a { text-decoration: underline; }
</style>
<script src="core/jquery.js"></script>
<script src="core/velocity.min.js"></script>
<script src="core/scanner.js"></script>
<script src="core/deviantCollection.js"></script>
<script src="core/find.js"></script>
<script src="core/core.js"></script>
<script>
"use strict";
Components.utils.import("chrome://DeviantLove/content/global.js");
Components.utils.import("resource://gre/modules/Services.jsm");
var mainWindow, blacklist, winEnum = Services.ww.getWindowEnumerator();
var blacklist = document.createProcessingInstruction("xml-stylesheet",
	'href="chrome://DeviantLove/content/contextMenuBlacklist.css" type="text/css"');
while (!mainWindow) {
	let win = winEnum.getNext().QueryInterface(Components.interfaces.nsIDOMWindow);
	let sidebarBrowser = win.document.getElementById("sidebar");
	if (!sidebarBrowser) { continue; }
	let panelBrowser = sidebarBrowser.contentDocument.getElementById("web-panels-browser");
	if (!panelBrowser) { continue; }
	if (panelBrowser.contentWindow == window) {
		mainWindow = win;
		mainWindow[browserMod].sidebarLoaded(window);
		let blacklistTarget = sidebarBrowser.contentDocument;
		blacklistTarget.insertBefore(blacklist, blacklistTarget.firstChild);
	}
}
var resolvePrefs;
var prefsPromise = new Promise((resolve) => { resolvePrefs = resolve; });
const messageActions = {
	allPrefs({prefs}) {
		resolvePrefs(prefs);
	},
	changedPrefs({newPrefs}) {
		prefsPromise = prefsPromise.then((prefs) => {
			return Object.assign(prefs, newPrefs);
		});
	}
};
webExt.port.onMessage.addListener((thing) => {
	messageActions[thing.action](thing);
});
webExt.port.postMessage({action: "sendPrefs"});
var adapter = {
	displayType: "sidebar",
	getL10nMsg: function(msgName, replacements) {
		return l10n.get(msgName, replacements);
	},
	getL10nFile: function(filename) {
		return l10n.get("l10nFolder") + filename;
	},
	retrieve: function(keys) {
		var request = new $.Deferred();
		if (!Array.isArray(keys)) { keys = [keys]; }
		prefsPromise.then((prefs) => {
			var data = {};
			for (let key of keys) {
				let item = prefs[key];
				if (typeof item == "string") {
					item = JSON.parse(item);
				}
				data[key] = item;
			}
			request.resolve(data);
		});
		return request.promise();
	},
	store: function(key, data) {
		if (typeof data != "number" && typeof data != "boolean") {
			data = JSON.stringify(data);
		}
		webExt.port.postMessage({ action: "setPrefs", prefs: {[key]: data} });
	},
	prepComplete: function(results) {
		var scanData = Object.assign({}, results);
		scanData.deviants = results.deviants.getRestoreData();
		mainWindow[browserMod].currentScanData = scanData;
	}
};
var scannerController;
$(document).ready( function() {
	$("body").css("margin", 0);
	var reloadButton = mainWindow.document.getElementById("DeviantLoveReload");
	reloadButton.addEventListener("command", restart, false);
	reloadButton.hidden = false;
	$(window).bind("unload", function() {
		reloadButton.hidden = true;
		reloadButton.removeEventListener("command", restart, false);
		blacklist.remove();
		mainWindow[browserMod].sidebarUnloaded();
	});
	rawk();
} );
function restart() {
	if (scannerController) {scannerController.cancel()};
	$("body").empty();
	delete mainWindow[browserMod].currentScanData;
	rawk();
}
function rawk() {
	var pageData = mainWindow[browserMod].currentPageData;
	if (!pageData) {
		// The sidebar was left open when the user closed the browser. Close it now.
		mainWindow.SidebarUI.hide();
	}
	if (!mainWindow[browserMod].currentScanData) {
		beginPreparations(pageData);
		scannerController = startScan();
	} else {
		restore(mainWindow[browserMod].currentScanData, pageData);
	}
	if (mainWindow[browserMod].firstDeviant) {
		showDeviant(mainWindow[browserMod].firstDeviant);
		delete mainWindow[browserMod].firstDeviant;
	}
}

$(document).delegate("a", "click", function(event) {
	event.preventDefault();
} ).delegate("a", "mouseup", function(event) {
	if (event.button == 2) { return; };
	// Mimic Chrome behavior
	var where = mainWindow.whereToOpenLink(event);
	if (where == "current") {
		mainWindow.gBrowser.selectedTab = mainWindow.gBrowser.addTab(this.href);
	} else {
		mainWindow.openUILinkIn(this.href, where);
	}
} );
</script>
<body class="sidebar"></body>
</html>