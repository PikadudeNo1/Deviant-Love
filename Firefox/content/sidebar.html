<!--
	This file is part of Deviant Love.
	Copyright Pikadude No. 1
	Check core.js for the complete legal stuff.
-->
<!doctype html>
<html>
<title>Deviant Love Sidebar</title>
<link rel="stylesheet" href="core/builtinskin.css" type="text/css">
<style type="text/css">
body { height: 100vh; }
a { text-decoration: underline; }
</style>
<script type="text/javascript" src="core/jquery.js"></script>
<script type="text/javascript" src="core/velocity.min.js"></script>
<script type="text/javascript" src="core/core.js"></script>
<script type="text/javascript" src="core/scanner.js"></script>
<script type="text/javascript;version=1.7">
"use strict";
Components.utils.import("chrome://DeviantLove/content/global.js");
var adapter = {
	displayType: "sidebar",
	getL10nMsg: function(msgName, replacements) {
		if (!replacements) {
			return l10n.getString(msgName);
		} else {
			return l10n.getFormattedString(msgName, replacements);
		}
	},
	getL10nFile: function(filename) {
		return "chrome://DeviantLove/locale/" + filename;
	},
	retrieve: function(keys) {
		if (!Array.isArray(keys)) { keys = [keys]; }
		var items = prefs.get(keys);
		var data = {};
		keys.forEach( function(key, i) {
			var item = items[i];
			if (typeof item == "string") {
				item = JSON.parse(item);
			}
			data[key] = item;
		} );
		return $.when( data );
	},
	store: function(key, data) {
		if (typeof data != "number" && typeof data != "boolean") {
			data = JSON.stringify(data);
		}
		prefs.set(key, data);
	},
	prepComplete: function(restoreData) {
		top[browserMod].currentScanData = restoreData;
	}
};
var scannerController;
$(document).ready( function() {
	window[loaded] = true;
	$("body").css("margin", 0);
	var reloadButton = top.document.getElementById("DeviantLoveReload");
	reloadButton.addEventListener("command", restart, false);
	reloadButton.hidden = false;
	var sidebarBrowser = top.document.getElementById("sidebar");
	sidebarBrowser.setAttribute("tooltip", "aHTMLTooltip");
	var contextMenu = top.document.getElementById("contentAreaContextMenu");
	contextMenu.addEventListener("popupshowing", enforceWhitelist, false);
	contextMenu.addEventListener("popuphidden", unenforceWhitelist, false);
	sidebarBrowser.setAttribute("contextmenu", contextMenu.id);
	$(window).bind("unload", function() {
		reloadButton.hidden = true;
		reloadButton.removeEventListener("command", restart, false);
		contextMenu.removeEventListener("popupshowing", enforceWhitelist, false);
		contextMenu.removeEventListener("popuphidden", unenforceWhitelist, false);
		sidebarBrowser.removeAttribute("tooltip");
		sidebarBrowser.removeAttribute("contextmenu");
		top[browserMod].sidebarUnloaded();
	});
	function enforceWhitelist() {
		if (document.contains(top.gContextMenu.target)) {
			var failed = contextMenu.querySelectorAll("*:not(.DeviantLoveWhitelisted)");
			for (let i = 0; i < failed.length; ++i) {
				failed[i].className += " DeviantLoveWhitelistFail";
			}
		}
	}
	function unenforceWhitelist() {
		var failed = contextMenu.querySelectorAll(".DeviantLoveWhitelistFail");
		for (let i = 0; i < failed.length; ++i) {
			failed[i].className = failed[i].className.replace("DeviantLoveWhitelistFail", "");
		}
	}
	rawk();
} );
function restart() {
	if (scannerController) {scannerController.cancel()};
	$("body").empty();
	delete top[browserMod].currentScanData;
	rawk();
}
function rawk() {
	var pageData = top[browserMod].currentPageData;
	if (!pageData) {
		// The sidebar was left open when the user closed the browser. Close it now.
		top.toggleSidebar();
	}
	fulfillPurpose(pageData);
	if (top[browserMod].firstDeviant) {
		showDeviant(top[browserMod].firstDeviant);
		delete top[browserMod].firstDeviant;
	}
	if (!top[browserMod].currentScanData) {
		scannerController = startScan();
	} else {
		restore(top[browserMod].currentScanData);
	}
}

$(document).delegate("a", "click", function(event) {
	event.preventDefault();
} ).delegate("a", "mouseup", function(event) {
	if (event.button == 2) { return; };
	// Mimic Chrome behavior
	var where = top.whereToOpenLink(event);
	if (where == "current") {
		top.gBrowser.selectedTab = top.gBrowser.addTab(this.href);
	} else {
		top.openUILinkIn(this.href, where);
	}
} );
</script>
<body class="sidebar"></body>
</html>