<!--
	This file is part of Deviant Love.
	Copyright 2010 Pikadude No. 1
	Check core.js for the complete legal stuff.
-->
<!doctype html>
<html>
<title>Deviant Love Sidebar</title>
<link rel="stylesheet" href="core/builtinskin.css" type="text/css">
<script type="text/javascript" src="core/jquery.js"></script>
<script type="text/javascript" src="core/core.js"></script>
<script type="text/javascript">
var currentXHR;
$(document).ready( function() {
	window.DeviantLove = true;
	setL10n(top.DeviantLove.popupText);
	var reloadButton = top.document.getElementById("DeviantLoveReload");
	reloadButton.addEventListener("command", restart, false);
	reloadButton.hidden = false;
	$(window).bind("unload", function() {
		reloadButton.hidden = true;
		reloadButton.removeEventListener("command", restart, false);
	});
	rawk();
} );
function restart() {
	if (currentXHR) {currentXHR.abort();};
	$("body").empty();
	rawk();
}
function rawk() {
	var pageData = top.DeviantLove.currentPageData;
	if (!pageData) {
		// The sidebar was left open when the user closed the browser. Close it now.
		// Tried handling this in the overlay script, but toggleSidebar wasn't doing anything in load or unload handlers.
		top.toggleSidebar();
	}
	fulfillPurpose(pageData.pageType, pageData.ownerOrTitle);
	var currentURL;
	var scanSettings = {
		dataType: "xml",
		beforeSend: function(XHR) {currentXHR = XHR},
		success: scanFeed,
		error: function() {
			// TODO: Write this
			}
	};
	currentURL = pageData.feedHref;
	$.ajax( $.extend( {}, scanSettings, {url: currentURL} ) );
	function scanFeed(feed) {
		var data = [];
		$("item", feed).each( function() {
			var item = {
				deviationName: $("title:eq(0)", this).text(),
				deviationPage: $("link", this).text(),
				artistName: $('[role="author"]:eq(0)', this).text(),
				artistAvatar: $('[role="author"]:eq(1)', this).text(),
				artistProfile: $("copyright", this).attr("url")
			};
			item.artistGallery = item.artistProfile + "/gallery/";
			data.push(item);
		} );
		collectData(data);
		var nextPage = $('channel > [rel="next"]', feed);
		if (nextPage.length >= 1) {
			currentURL = nextPage.attr("href");
			$.ajax( $.extend( {}, scanSettings, {url: currentURL} ) );
		} else {
			// scanDone_startFun(top.DeviantLove.getTip());
		}
	}
}
if (document.createElement("i").style.MozTransition !== undefined) {
	var cssTransitions = {
		eventName: "transitionend",
		propertyName: "-moz-transition"
	};
} else {
	var cssTransitions = false;
}
</script>
<body></body>
</html>